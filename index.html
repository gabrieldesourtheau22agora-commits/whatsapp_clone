<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GabyTchat Pro - Final Version</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, updateProfile, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, where, onSnapshot, serverTimestamp, doc, setDoc, getDocs, deleteDoc, updateDoc, arrayUnion, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
  apiKey: "AIzaSyC2WV8dC2JcHS46_-jgSDzS_gAFV9rXsHI",
  authDomain: "gabytchat.firebaseapp.com",
  projectId: "gabytchat",
  storageBucket: "gabytchat.firebasestorage.app",
  messagingSenderId: "1099022563554",
  appId: "1:1099022563554:web:3a867d42fea53d892686bb",
  measurementId: "G-2JDV3F5Q76"
};

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const { createApp, ref, nextTick, computed, watch } = Vue;

        createApp({
            setup() {
                const user = ref(null);
                const rooms = ref([]);
                const activeRoom = ref(null);
                const messages = ref([]);
                const newMessage = ref("");
                const isLogin = ref(true);
                const email = ref("");
                const password = ref("");
                const username = ref("");
                const view = ref('chats');
                const userPresence = ref('online');
                const otherUserStatus = ref({});
                const notifications = ref([]);
                const searchPseudo = ref("");
                const groupName = ref("");
                const selectedFriends = ref([]);
                const showChatOnMobile = ref(false);

                const handleAuth = async () => {
                    try {
                        if (isLogin.value) {
                            await signInWithEmailAndPassword(auth, email.value, password.value);
                        } else {
                            if (!username.value) return alert("Pseudo requis");
                            const res = await createUserWithEmailAndPassword(auth, email.value, password.value);
                            await updateProfile(res.user, { displayName: username.value });
                            await setDoc(doc(db, "users", res.user.uid), { uid: res.user.uid, pseudo: username.value, status: 'online' });
                        }
                    } catch (e) { alert("Erreur : " + e.message); }
                };

                onAuthStateChanged(auth, (u) => {
                    user.value = u;
                    if (u) {
                        onSnapshot(query(collection(db, "notifications"), where("toId", "==", u.uid)), (snap) => {
                            notifications.value = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        });
                        onSnapshot(query(collection(db, "rooms"), where("members", "array-contains", u.uid)), (snap) => {
                            rooms.value = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                            rooms.value.forEach(room => {
                                room.members.forEach(mId => {
                                    if (mId !== u.uid) onSnapshot(doc(db, "users", mId), (d) => { otherUserStatus.value[mId] = d.data()?.status || 'offline'; });
                                });
                            });
                        });
                    }
                });

                watch(userPresence, async (val) => { if (user.value) await updateDoc(doc(db, "users", user.value.uid), { status: val }); });

                const selectRoom = (room) => {
                    activeRoom.value = room;
                    showChatOnMobile.value = true;
                    onSnapshot(query(collection(db, "rooms", room.id, "messages"), orderBy("createdAt", "asc")), async (snap) => {
                        const msgs = [];
                        const batch = writeBatch(db);
                        snap.docs.forEach(d => {
                            const data = d.data();
                            msgs.push({ id: d.id, ...data });
                            if (data.uid !== user.value.uid && !data.read) batch.update(doc(db, "rooms", room.id, "messages", d.id), { read: true });
                        });
                        messages.value = msgs;
                        await batch.commit().catch(()=>{});
                        nextTick(() => { const el = document.getElementById('chat-scroll'); if(el) el.scrollTop = el.scrollHeight; });
                    });
                };

                const sendMessage = async () => {
                    if (!newMessage.value.trim()) return;
                    const txt = newMessage.value; newMessage.value = "";
                    await addDoc(collection(db, "rooms", activeRoom.value.id, "messages"), { text: txt, uid: user.value.uid, sender: user.value.displayName, createdAt: serverTimestamp(), read: false });
                };

                const handleTyping = async () => {
                    if(!activeRoom.value) return;
                    await updateDoc(doc(db, "rooms", activeRoom.value.id), { [`typing.${user.value.uid}`]: true });
                    setTimeout(async () => { if(activeRoom.value) await updateDoc(doc(db, "rooms", activeRoom.value.id), { [`typing.${user.value.uid}`]: false }); }, 2000);
                };

                const renameRoom = async () => {
                    const newName = prompt("Nouveau nom :", activeRoom.value.name);
                    if (newName) await updateDoc(doc(db, "rooms", activeRoom.value.id), { name: newName });
                };

                return { 
                    user, rooms, activeRoom, messages, newMessage, isLogin, email, password, username, view, userPresence, otherUserStatus, searchPseudo, groupName, selectedFriends, showChatOnMobile, notifications,
                    handleAuth, selectRoom, sendMessage, handleTyping, renameRoom, logout: () => signOut(auth),
                    isTyping: computed(() => { if (!activeRoom.value?.typing) return false; return Object.keys(activeRoom.value.typing).some(id => id !== user.value.uid && activeRoom.value.typing[id]); }),
                    friendsList: computed(() => rooms.value.filter(r => r.type === 'private').map(r => ({ id: r.members.find(m => m !== user.value.uid), name: r.name }))),
                    sendFriendRequest: async () => {
                        const q = query(collection(db, "users"), where("pseudo", "==", searchPseudo.value.trim()));
                        const snap = await getDocs(q);
                        if (snap.empty) return alert("Inconnu");
                        await addDoc(collection(db, "notifications"), { fromId: user.value.uid, fromName: user.value.displayName, toId: snap.docs[0].id });
                        searchPseudo.value = ""; alert("Envoy√© !");
                    },
                    createGroup: async () => {
                        if(!groupName.value) return alert("Nom du groupe requis");
                        await addDoc(collection(db, "rooms"), { name: groupName.value, members: [user.value.uid, ...selectedFriends.value], type: "group", owner: user.value.uid });
                        view.value = 'chats'; groupName.value = ""; selectedFriends.value = [];
                    },
                    acceptFriend: async (n) => {
                        const rId = [user.value.uid, n.fromId].sort().join("_");
                        await setDoc(doc(db, "rooms", rId), { name: n.fromName, members: [user.value.uid, n.fromId], type: "private" });
                        await deleteDoc(doc(db, "notifications", n.id));
                        view.value = 'chats';
                    }
                };
            }
        }).mount('#app');
    </script>
    <style>
        .bg-chat { background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-color: #e5ddd5; }
        .blue-check { color: #34b7f1; }
        @media (max-width: 767px) {
            .mobile-hide { display: none !important; }
            .mobile-show-flex { display: flex !important; width: 100% !important; position: fixed !important; inset: 0 !important; z-index: 100; }
        }
    </style>
</head>
<body class="h-screen w-screen bg-gray-100 overflow-hidden font-sans m-0 p-0">
    <div id="app" class="h-full w-full">
        
        <div v-if="!user" class="h-full w-full flex items-center justify-center bg-[#f0f2f5] p-4">
            <form @submit.prevent="handleAuth" class="bg-white p-6 md:p-8 rounded-2xl shadow-xl w-full max-w-md border-t-8 border-green-600">
                <h1 class="text-2xl font-black text-center mb-6 text-gray-700 uppercase">GABYTCHAT PRO</h1>
                
                <input v-if="!isLogin" v-model="username" type="text" placeholder="Pseudo" class="w-full border p-3 rounded-xl mb-3 outline-none focus:ring-2 ring-green-500">
                <input v-model="email" type="email" placeholder="Email" class="w-full border p-3 rounded-xl mb-3 outline-none focus:ring-2 ring-green-500">
                <input v-model="password" type="password" placeholder="Mot de passe" class="w-full border p-3 rounded-xl mb-6 outline-none focus:ring-2 ring-green-500">
                
                <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold uppercase shadow-lg active:scale-95 transition">
                    {{ isLogin ? 'Se connecter' : 'S\'inscrire' }}
                </button>
                <p @click="isLogin = !isLogin" class="text-center text-sm text-blue-500 mt-6 cursor-pointer underline">Basculer Mode</p>
            </form>
        </div>

        <div v-else class="h-full w-full flex overflow-hidden">
            <aside :class="['w-full md:w-[380px] border-r bg-white flex flex-col', showChatOnMobile ? 'mobile-hide' : 'flex']">
                <header class="p-4 bg-[#ededed] flex justify-between items-center border-b">
                    <div class="flex flex-col">
                        <span class="font-bold text-sm">@{{ user.displayName }}</span>
                        <select v-model="userPresence" class="text-[10px] bg-transparent font-bold uppercase outline-none" :class="userPresence === 'online' ? 'text-green-500' : 'text-gray-400'">
                            <option value="online">‚óè En ligne</option>
                            <option value="offline">‚óã Invisible</option>
                        </select>
                    </div>
                    <div class="flex gap-3">
                        <button @click="view = 'createGroup'" class="text-xl">üë•</button>
                        <button @click="view = 'notifs'" class="relative text-xl">
                            üîî<span v-if="notifications.length" class="absolute -top-1 -right-1 bg-red-500 text-[10px] text-white w-4 h-4 flex items-center justify-center rounded-full">{{ notifications.length }}</span>
                        </button>
                        <button @click="logout" class="text-[9px] font-black uppercase text-red-500">Quitter</button>
                    </div>
                </header>

                <div class="flex-1 overflow-y-auto">
                    <div v-if="view === 'chats'">
                        <form @submit.prevent="sendFriendRequest" class="p-4">
                            <input v-model="searchPseudo" placeholder="Ajouter pseudo + Entr√©e" class="w-full p-3 bg-gray-100 rounded-xl outline-none text-sm">
                        </form>
                        <div v-for="r in rooms" @click="selectRoom(r)" :class="['p-4 border-b flex items-center gap-3 cursor-pointer hover:bg-gray-50', activeRoom?.id === r.id ? 'bg-gray-100' : '']">
                            <div class="relative shrink-0">
                                <div :class="['w-12 h-12 rounded-full flex items-center justify-center text-white font-bold', r.type==='group'?'bg-indigo-500':'bg-green-600']">{{ r.name[0] }}</div>
                                <div v-if="r.type === 'private' && otherUserStatus[r.members.find(m=>m!==user.uid)] === 'online'" class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white rounded-full"></div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="font-bold text-sm truncate text-gray-800">{{ r.name }}</p>
                                <p class="text-[9px] uppercase font-bold text-gray-400 tracking-tight">{{ r.type }}</p>
                            </div>
                        </div>
                    </div>

                    <form v-else-if="view === 'createGroup'" @submit.prevent="createGroup" class="p-6">
                        <button type="button" @click="view = 'chats'" class="text-[10px] font-bold text-blue-500 mb-4 uppercase tracking-widest">‚Üê Annuler</button>
                        <input v-model="groupName" placeholder="Nom du groupe" class="w-full border p-3 rounded-xl mb-4 text-sm outline-none">
                        <p class="text-[9px] font-black text-gray-400 uppercase mb-3 border-b pb-2 text-center">S√©lectionner amis</p>
                        <div v-for="f in friendsList" class="flex items-center gap-3 p-3 bg-gray-50 rounded-xl mb-2">
                            <input type="checkbox" :value="f.id" v-model="selectedFriends" class="w-5 h-5">
                            <span class="font-bold text-sm">{{ f.name }}</span>
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold mt-4 shadow-lg uppercase text-xs">Cr√©er Groupe</button>
                    </form>

                    <div v-else class="p-4">
                        <button @click="view = 'chats'" class="text-[10px] font-bold text-blue-500 mb-4 uppercase tracking-widest">‚Üê Retour</button>
                        <div v-for="n in notifications" class="p-4 border rounded-xl shadow-sm bg-white mb-3">
                            <p class="text-sm font-bold text-gray-700">{{ n.fromName }}</p>
                            <button @click="acceptFriend(n)" class="w-full bg-green-500 text-white py-2 rounded-lg mt-2 text-[10px] font-black uppercase">Accepter</button>
                        </div>
                    </div>
                </div>
            </aside>

            <main :class="['flex-1 flex flex-col bg-chat relative', showChatOnMobile ? 'mobile-show-flex' : 'mobile-hide md:flex']">
                <template v-if="activeRoom">
                    <header class="p-3 bg-[#f0f0f0] border-b flex items-center justify-between shadow-sm z-[110]">
                        <div class="flex items-center gap-3">
                            <button @click="showChatOnMobile = false" class="md:hidden text-2xl px-1">‚Üê</button>
                            <div class="flex flex-col">
                                <p class="font-bold text-sm leading-tight truncate max-w-[150px] md:max-w-none">{{ activeRoom.name }}</p>
                                <p v-if="isTyping" class="text-[10px] text-green-600 font-bold italic animate-pulse">√©crit...</p>
                            </div>
                        </div>
                        <button @click="renameRoom" class="text-[9px] bg-white border border-gray-300 px-3 py-1.5 rounded-lg font-black uppercase">‚úé Nom</button>
                    </header>

                    <div id="chat-scroll" class="flex-1 overflow-y-auto p-4 flex flex-col gap-2">
                        <div v-for="m in messages" :class="['p-3 rounded-2xl shadow-sm text-sm max-w-[85%] md:max-w-[70%] break-words relative', m.uid === user.uid ? 'self-end bg-[#dcf8c6] rounded-tr-none' : 'self-start bg-white rounded-tl-none']">
                            <p v-if="activeRoom.type === 'group' && m.uid !== user.uid" class="text-[9px] font-black text-indigo-500 mb-1">@{{ m.sender }}</p>
                            <p class="text-gray-800 leading-snug">{{ m.text }}</p>
                            <div v-if="m.uid === user.uid" class="text-right text-[10px] mt-1 leading-none font-bold">
                                <span :class="m.read ? 'blue-check' : 'text-gray-400'">{{ m.read ? '‚úì‚úì' : '‚úì' }}</span>
                            </div>
                        </div>
                    </div>

                    <footer class="p-3 bg-[#f0f0f0] border-t z-[110]">
                        <form @submit.prevent="sendMessage" class="flex gap-2">
                            <input v-model="newMessage" @input="handleTyping" type="text" placeholder="Message..." class="flex-1 p-3.5 rounded-full outline-none bg-white shadow-inner text-sm">
                            <button type="submit" class="bg-[#075e54] text-white w-12 h-12 rounded-full flex items-center justify-center shadow-lg active:scale-90 transition">‚ûî</button>
                        </form>
                    </footer>
                </template>
                <div v-else class="flex-1 flex flex-col items-center justify-center text-gray-300 p-10 text-center">
                    <div class="text-6xl mb-4 opacity-20">üí¨</div>
                    <p class="font-black uppercase tracking-widest text-[10px]">GABYTCHAT PRO - S√©lectionnez un salon</p>
                </div>
            </main>
        </div>
    </div>
</body>

</html>
